name: "Playwright - sorry-currents sharding"

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  SHARD_COUNT: 3

jobs:
  plan:
    name: Plan shards
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.plan.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: playwright-e2e/package-lock.json
      - name: Install dependencies
        working-directory: playwright-e2e
        run: npm ci
      - name: Download previous timing data
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p playwright-e2e/.sorry-currents
          # Find the most recent successful workflow run (excluding current)
          RUN_ID=$(gh api \
            "repos/${{ github.repository }}/actions/workflows/playwright-sorry-currents.yml/runs?status=completed&per_page=5" \
            --jq ".workflow_runs[0].id // empty")
          if [ -z "$RUN_ID" ]; then
            echo "No previous runs found — cold start"
            exit 0
          fi
          echo "Found previous run: $RUN_ID"
          # Find the timing artifact in that run
          ARTIFACT_ID=$(gh api \
            "repos/${{ github.repository }}/actions/runs/$RUN_ID/artifacts" \
            --jq '.artifacts[] | select(.name == "sorry-currents-timing") | .id // empty')
          if [ -z "$ARTIFACT_ID" ]; then
            echo "No timing artifact in run $RUN_ID — cold start"
            exit 0
          fi
          echo "Downloading timing artifact $ARTIFACT_ID"
          gh api \
            "repos/${{ github.repository }}/actions/artifacts/$ARTIFACT_ID/zip" \
            > /tmp/timing.zip
          unzip -o /tmp/timing.zip -d playwright-e2e/.sorry-currents/
          echo "Timing data restored"
      - name: Generate shard plan
        id: plan
        working-directory: playwright-e2e
        run: npx @sorry-currents/cli plan --shards ${{ env.SHARD_COUNT }} --output-matrix
      - name: Upload shard plan
        uses: actions/upload-artifact@v4
        with:
          name: sorry-currents-shard-plan
          path: playwright-e2e/.sorry-currents/shard-plan.json
          retention-days: 1
          if-no-files-found: warn

  test:
    name: "Shard ${{ matrix.shardIndex }}"
    needs: plan
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.plan.outputs.matrix) }}
    env:
      SORRY_CURRENTS_RUN_ID: ${{ github.run_id }}-${{ github.run_attempt }}
      SORRY_CURRENTS_SHARD_TOTAL: ${{ matrix.shardTotal }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: playwright-e2e/package-lock.json
      - name: Install dependencies
        working-directory: playwright-e2e
        run: npm ci
      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: pw-browsers-${{ hashFiles('playwright-e2e/package-lock.json') }}
      - name: Install Playwright browsers
        if: steps.pw-cache.outputs.cache-hit != 'true'
        working-directory: playwright-e2e
        run: npx playwright install --with-deps chromium
      - name: Install Playwright system deps (cache hit)
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium
        working-directory: playwright-e2e
      - name: Download shard plan
        uses: actions/download-artifact@v4
        with:
          name: sorry-currents-shard-plan
          path: playwright-e2e/.sorry-currents/
        continue-on-error: true
      - name: Run tests
        working-directory: playwright-e2e
        run: |
          if [ -f .sorry-currents/shard-plan.json ]; then
            npx @sorry-currents/cli run \
              --shard-plan .sorry-currents/shard-plan.json \
              --shard-index ${{ matrix.shardIndex }}
          else
            npx @sorry-currents/cli run --shard-index ${{ matrix.shardIndex }}
          fi
      - name: Upload shard results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sorry-currents-shard-${{ matrix.shardIndex }}
          path: playwright-e2e/.sorry-currents/runs/
          retention-days: 7

  report:
    name: Merge & report
    needs: test
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: playwright-e2e/package-lock.json
      - name: Install dependencies
        working-directory: playwright-e2e
        run: npm ci
      - name: Download all shard results
        uses: actions/download-artifact@v4
        with:
          pattern: sorry-currents-shard-*
          path: playwright-e2e/.sorry-currents/shards/
      - name: Merge shard results
        working-directory: playwright-e2e
        run: npx @sorry-currents/cli merge
      - name: Generate HTML report
        working-directory: playwright-e2e
        run: npx @sorry-currents/cli report --format html
      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: sorry-currents-html-report
          path: playwright-e2e/.sorry-currents/report/
          retention-days: 30
      - name: Upload timing data for next run
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sorry-currents-timing
          path: playwright-e2e/.sorry-currents/timing-data.json
          retention-days: 90
          if-no-files-found: warn
      - name: Print summary
        working-directory: playwright-e2e
        run: npx @sorry-currents/cli report --format markdown